"use strict";(self.webpackChunkblog_sample=self.webpackChunkblog_sample||[]).push([[4010],{3250:(e,d,n)=>{n.r(d),n.d(d,{assets:()=>s,contentTitle:()=>o,default:()=>m,frontMatter:()=>i,metadata:()=>r,toc:()=>l});var t=n(5893),a=n(1151);const i={title:"reduce\u4f18\u5316\u601d\u8def"},o="baseline\u7b97\u6cd5",r={id:"ml/optimization/reduce\u4f18\u5316",title:"reduce\u4f18\u5316\u601d\u8def",description:"\u5728\u7b2c\u4e00\u4e2a\u6b65\u9aa4\u4e2d\uff0c\u6211\u4eec\u8ba9Numperblock\u4e0eThreadperblock\u4e00\u81f4\uff0c\u6bcf\u4e2ablock\u8bbe\u5b9a\u4e3a256\u4e2a\u7ebf\u7a0b\uff0c\u4e00\u4e2ablock\u8d1f\u8d23256\u4e2a\u6570\u636e\u7684reduce\u5de5\u4f5c\u3002\u5047\u8bbe\u9700\u8981\u5904\u740632M\u7684\u6570\u636e\uff0c\u5219\u6709128K\u4e2ablock\u3002tid\u4ee3\u8868\u7ebf\u7a0b\u53f7\uff0ci\u4ee3\u8868\u5728\u539f\u59cb\u6570\u7ec4\u4e2d\u7684\u7d22\u5f15\u53f7\u3002\u7b2ctid\u53f7\u7ebf\u7a0b\u5c06\u7b2ci\u53f7\u7684\u6570\u636e\u4eceglobal\u4e2d\u53d6\u51fa\uff0c\u653e\u5230shared memory\u7684\u7b2ctid\u5143\u7d20\u4e2d\u3002\u6bd4\u5982\u5728\u7b2c0\u53f7block\u4e2d\uff0c0\u53f7\u7ebf\u7a0b\u5c060\u53f7\u5143\u7d20\u53d6\u51fa\uff0c\u653e\u5230shared memory\u7684\u7b2c0\u53f7\u4f4d\u7f6e\u3002",source:"@site/docs/ml/optimization/reduce\u4f18\u5316.md",sourceDirName:"ml/optimization",slug:"/ml/optimization/reduce\u4f18\u5316",permalink:"/docs/ml/optimization/reduce\u4f18\u5316",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/edit/main/website/docs/ml/optimization/reduce\u4f18\u5316.md",tags:[],version:"current",lastUpdatedAt:1712590607,formattedLastUpdatedAt:"Apr 8, 2024",frontMatter:{title:"reduce\u4f18\u5316\u601d\u8def"},sidebar:"tutorialSidebar",previous:{title:"onnx \u6a21\u578b\u4fee\u6539",permalink:"/docs/ml/optimization/onnx_modify"},next:{title:"\u786c\u6838\u8be6\u89e3Segment Anything Model (SAM) TensorRT\u6a21\u578b\u8f6c\u6362",permalink:"/docs/ml/optimization/sam"}},s={},l=[];function c(e){const d={code:"code",h1:"h1",img:"img",p:"p",pre:"pre",...(0,a.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(d.h1,{id:"baseline\u7b97\u6cd5",children:"baseline\u7b97\u6cd5"}),"\n",(0,t.jsx)(d.pre,{children:(0,t.jsx)(d.code,{className:"language-cuda",children:"__global__ void reduce0(float *d_in,float *d_out){\n    __shared__ float sdata[THREAD_PER_BLOCK];\n\n    //each thread loads one element from global memory to shared mem\n    unsigned int i=blockIdx.x*blockDim.x+threadIdx.x;\n    unsigned int tid=threadIdx.x;\n    sdata[tid]=d_in[i];\n    __syncthreads();\n\n    // do reduction in shared mem\n    for(unsigned int s=1; s<blockDim.x; s*=2){\n        if(tid%(2*s) == 0){\n            sdata[tid]+=sdata[tid+s];\n        }\n        __syncthreads();\n    }\n    \n    // write result for this block to global mem\n    if(tid==0)d_out[blockIdx.x]=sdata[tid];\n}\n"})}),"\n",(0,t.jsx)(d.p,{children:"\u5728\u7b2c\u4e00\u4e2a\u6b65\u9aa4\u4e2d\uff0c\u6211\u4eec\u8ba9Num_per_block\u4e0eThread_per_block\u4e00\u81f4\uff0c\u6bcf\u4e2ablock\u8bbe\u5b9a\u4e3a256\u4e2a\u7ebf\u7a0b\uff0c\u4e00\u4e2ablock\u8d1f\u8d23256\u4e2a\u6570\u636e\u7684reduce\u5de5\u4f5c\u3002\u5047\u8bbe\u9700\u8981\u5904\u740632M\u7684\u6570\u636e\uff0c\u5219\u6709128K\u4e2ablock\u3002tid\u4ee3\u8868\u7ebf\u7a0b\u53f7\uff0ci\u4ee3\u8868\u5728\u539f\u59cb\u6570\u7ec4\u4e2d\u7684\u7d22\u5f15\u53f7\u3002\u7b2ctid\u53f7\u7ebf\u7a0b\u5c06\u7b2ci\u53f7\u7684\u6570\u636e\u4eceglobal\u4e2d\u53d6\u51fa\uff0c\u653e\u5230shared memory\u7684\u7b2ctid\u5143\u7d20\u4e2d\u3002\u6bd4\u5982\u5728\u7b2c0\u53f7block\u4e2d\uff0c0\u53f7\u7ebf\u7a0b\u5c060\u53f7\u5143\u7d20\u53d6\u51fa\uff0c\u653e\u5230shared memory\u7684\u7b2c0\u53f7\u4f4d\u7f6e\u3002"}),"\n",(0,t.jsx)(d.p,{children:"\u5230\u4e86\u7b2c\u4e8c\u4e2a\u9636\u6bb5\uff0cblock\u4e2d\u9700\u8981\u8ba1\u7b97\u7684256\u4e2a\u5143\u7d20\u5df2\u7ecf\u5168\u90e8\u88ab\u5b58\u50a8\u5728\u4e86shared memory\u4e2d\uff0c\u6b64\u65f6\u9700\u8981\u5bf9\u5176\u8fdb\u884creduce\u64cd\u4f5c\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u9700\u8981\u8fdb\u884c\u591a\u8f6e\u8fed\u4ee3\uff0c\u5728\u7b2c\u4e00\u8f6e\u8fed\u4ee3\u4e2d\uff0c\u5982\u679ctid%2 ==0, \u5219\u7b2ctid\u53f7\u7ebf\u7a0b\u5c06shared memory\u4e2d\u7b2ctid\u53f7\u4f4d\u7f6e\u7684\u503c\u548c\u7b2ctid+1\u53f7\u7684\u503c\u8fdb\u884c\u76f8\u52a0\uff0c\u800c\u540e\u653e\u5728\u7b2ctid\u53f7\u4f4d\u7f6e\u3002\u5728\u7b2c\u4e8c\u8f6e\u8fed\u4ee3\u4e2d\uff0c\u5982\u679ctid%4==0,\u5219\u7b2ctid\u53f7\u7ebf\u7a0b\u5c06shared memory\u4e2d\u7b2ctid\u53f7\u4f4d\u7f6e\u7684\u503c\u548c\u7b2ctid+2\u53f7\u7684\u503c\u8fdb\u884c\u76f8\u52a0\uff0c\u800c\u540e\u653e\u5728\u7b2ctid\u53f7\u4f4d\u7f6e\u3002\u4e0d\u65ad\u8fed\u4ee3\uff0c\u5219\u6240\u6709\u5143\u7d20\u90fd\u5c06\u88ab\u7d2f\u52a0\u5230\u7b2c0\u53f7\u4f4d\u7f6e\u3002"}),"\n",(0,t.jsx)(d.p,{children:"\u5728\u7b2c\u4e09\u4e2a\u9636\u6bb5\u4e2d\uff0cblock\u8d1f\u8d23\u7684256\u4e2a\u5143\u7d20\u4e4b\u548c\u90fd\u653e\u7f6e\u5728shared memory\u76840\u53f7\u4f4d\u7f6e\uff0c\u6b64\u65f6\uff0c\u53ea\u9700\u8981\u5c060\u53f7\u4f4d\u7f6e\u7684\u5143\u7d20\u5199\u56de\u5373\u53ef\u3002"}),"\n",(0,t.jsx)(d.h1,{id:"\u89e3\u51b3warp-divergence",children:"\u89e3\u51b3warp divergence"}),"\n",(0,t.jsx)(d.p,{children:"\u76ee\u524dreduce0\u5b58\u5728\u7684\u6700\u5927\u95ee\u9898\u5c31\u662fwarp divergent\u7684\u95ee\u9898\u3002\u5bf9\u4e8e\u4e00\u4e2ablock\u800c\u8a00\uff0c\u5b83\u6240\u6709\u7684thread\u90fd\u662f\u6267\u884c\u540c\u4e00\u6761\u6307\u4ee4\u3002\u5982\u679c\u5b58\u5728if-else\u8fd9\u6837\u7684\u5206\u652f\u60c5\u51b5\u7684\u8bdd\uff0cthread\u4f1a\u6267\u884c\u6240\u6709\u7684\u5206\u652f\u3002\u53ea\u662f\u4e0d\u6ee1\u8db3\u6761\u4ef6\u7684\u5206\u652f\uff0c\u6240\u4ea7\u751f\u7684\u7ed3\u679c\u4e0d\u4f1a\u8bb0\u5f55\u4e0b\u6765\u3002\u53ef\u4ee5\u5728\u4e0a\u56fe\u4e2d\u770b\u5230\uff0c\u5728\u6bcf\u4e00\u8f6e\u8fed\u4ee3\u4e2d\u90fd\u4f1a\u4ea7\u751f\u4e24\u4e2a\u5206\u652f\uff0c\u5206\u522b\u662f\u7ea2\u8272\u548c\u6a59\u8272\u7684\u5206\u652f\u3002\u8fd9\u4e25\u91cd\u5f71\u54cd\u4e86\u4ee3\u7801\u6267\u884c\u7684\u6548\u7387\u3002"}),"\n",(0,t.jsx)(d.pre,{children:(0,t.jsx)(d.code,{className:"language-cuda",children:"__global__ void reduce1(float *d_in,float *d_out){\n    __shared__ float sdata[THREAD_PER_BLOCK];\n\n    //each thread loads one element from global memory to shared mem\n    unsigned int i=blockIdx.x*blockDim.x+threadIdx.x;\n    unsigned int tid=threadIdx.x;\n    sdata[tid]=d_in[i];\n    __syncthreads();\n\n    // do reduction in shared mem\n    for(unsigned int s=1; s<blockDim.x; s*=2){\n        int index = 2*s*tid;\n        if(index < blockDim.x){\n            sdata[index]+=sdata[index+s];\n        }\n        __syncthreads();\n    }\n    \n    // write result for this block to global mem\n    if(tid==0)d_out[blockIdx.x]=sdata[tid];\n}\n"})}),"\n",(0,t.jsx)(d.h1,{id:"\u89e3\u51b3bank\u51b2\u7a81",children:"\u89e3\u51b3bank\u51b2\u7a81"}),"\n",(0,t.jsx)(d.p,{children:"reduce1\u7684\u6700\u5927\u95ee\u9898\u662fbank\u51b2\u7a81\u3002\u6211\u4eec\u628a\u76ee\u5149\u805a\u7126\u5728\u8fd9\u4e2afor\u5faa\u73af\u4e2d\u3002\u5e76\u4e14\u53ea\u805a\u7126\u57280\u53f7warp\u3002\u5728\u7b2c\u4e00\u6b21\u8fed\u4ee3\u4e2d\uff0c0\u53f7\u7ebf\u7a0b\u9700\u8981\u53bbload shared memory\u76840\u53f7\u5730\u5740\u4ee5\u53ca1\u53f7\u5730\u5740\u7684\u6570\uff0c\u7136\u540e\u5199\u56de\u52300\u53f7\u5730\u5740\u3002\u800c\u6b64\u65f6\uff0c\u8fd9\u4e2awarp\u4e2d\u768416\u53f7\u7ebf\u7a0b\uff0c\u9700\u8981\u53bbload shared memory\u4e2d\u768432\u53f7\u5730\u5740\u548c33\u53f7\u5730\u5740\u3002\u53ef\u4ee5\u53d1\u73b0\uff0c0\u53f7\u5730\u5740\u8ddf32\u53f7\u5730\u5740\u4ea7\u751f\u4e862\u8def\u7684bank\u51b2\u7a81\u3002\u5728\u7b2c2\u6b21\u8fed\u4ee3\u4e2d\uff0c0\u53f7\u7ebf\u7a0b\u9700\u8981\u53bbload shared memory\u4e2d\u76840\u53f7\u5730\u5740\u548c2\u53f7\u5730\u5740\u3002\u8fd9\u4e2awarp\u4e2d\u76848\u53f7\u7ebf\u7a0b\u9700\u8981load shared memory\u4e2d\u768432\u53f7\u5730\u5740\u4ee5\u53ca34\u53f7\u5730\u5740\uff0c16\u53f7\u7ebf\u7a0b\u9700\u8981load shared memory\u4e2d\u768464\u53f7\u5730\u5740\u548c68\u53f7\u5730\u5740\uff0c24\u53f7\u7ebf\u7a0b\u9700\u8981load shared memory\u4e2d\u768496\u53f7\u5730\u5740\u548c100\u53f7\u5730\u5740\u3002\u53c8\u56e0\u4e3a0\u300132\u300164\u300196\u53f7\u5730\u5740\u5bf9\u5e94\u7740\u540c\u4e00\u4e2abank\uff0c\u6240\u4ee5\u6b64\u65f6\u4ea7\u751f\u4e864\u8def\u7684bank\u51b2\u7a81\u3002\u73b0\u5728\uff0c\u53ef\u4ee5\u7ee7\u7eed\u7b97\u4e0b\u53bb\uff0c8\u8defbank\u51b2\u7a81\uff0c16\u8defbank\u51b2\u7a81\u3002\u7531\u4e8ebank\u51b2\u7a81\uff0c\u6240\u4ee5reduce1\u6027\u80fd\u53d7\u9650\u3002"}),"\n",(0,t.jsx)(d.p,{children:(0,t.jsx)(d.img,{src:n(1519).Z+"",width:"663",height:"688"})}),"\n",(0,t.jsx)(d.pre,{children:(0,t.jsx)(d.code,{className:"language-cuda",children:"__global__ void reduce2(float *d_in,float *d_out){\n    __shared__ float sdata[THREAD_PER_BLOCK];\n\n    //each thread loads one element from global memory to shared mem\n    unsigned int i=blockIdx.x*blockDim.x+threadIdx.x;\n    unsigned int tid=threadIdx.x;\n    sdata[tid]=d_in[i];\n    __syncthreads();\n\n    // do reduction in shared mem\n    for(unsigned int s=blockDim.x/2; s>0; s>>=1){\n        if(tid < s){\n            sdata[tid]+=sdata[tid+s];\n        }\n        __syncthreads();\n    }\n    \n    // write result for this block to global mem\n    if(tid==0)d_out[blockIdx.x]=sdata[tid];\n}\n"})}),"\n",(0,t.jsx)(d.p,{children:"\u628a\u76ee\u5149\u7ee7\u7eed\u770b\u5230\u8fd9\u4e2afor\u5faa\u73af\u4e2d\uff0c\u5e76\u4e14\u53ea\u5206\u67900\u53f7warp\u30020\u53f7\u7ebf\u7a0b\u9700\u8981load shared memory\u76840\u53f7\u5143\u7d20\u4ee5\u53ca128\u53f7\u5143\u7d20\u30021\u53f7\u7ebf\u7a0b\u9700\u8981load shared memory\u4e2d\u76841\u53f7\u5143\u7d20\u548c129\u53f7\u5143\u7d20\u3002\u8fd9\u4e00\u8f6e\u8fed\u4ee3\u4e2d\uff0c\u5728\u8bfb\u53d6\u7b2c\u4e00\u4e2a\u6570\u65f6\uff0cwarp\u4e2d\u768432\u4e2a\u7ebf\u7a0b\u521a\u597dload \u4e00\u884cshared memory\u6570\u636e\u3002\u518d\u5206\u6790\u7b2c2\u8f6e\u8fed\u4ee3\uff0c0\u53f7\u7ebf\u7a0bload 0\u53f7\u5143\u7d20\u548c64\u53f7\u5143\u7d20\uff0c1\u53f7\u7ebf\u7a0bload 1\u53f7\u5143\u7d20\u548c65\u53f7\u5143\u7d20\u3002\u54a6\uff0c\u4e5f\u662f\u8fd9\u6837\uff0c\u6bcf\u6b21load shared memory\u7684\u4e00\u884c\u3002\u518d\u6765\u5206\u6790\u7b2c3\u8f6e\u8fed\u4ee3\uff0c0\u53f7\u7ebf\u7a0bload 0\u53f7\u5143\u7d20\u548c32\u53f7\u5143\u7d20\uff0c\u63a5\u4e0b\u6765\u4e0d\u5199\u4e86\uff0c\u603b\u4e4b\uff0c\u4e00\u4e2awarp load shared memory\u7684\u4e00\u884c\u3002\u6ca1\u6709bank\u51b2\u7a81\u3002\u5230\u4e864\u8f6e\u8fed\u4ee3\uff0c0\u53f7\u7ebf\u7a0bload 0\u53f7\u5143\u7d20\u548c16\u53f7\u5143\u7d20\u3002\u90a316\u53f7\u7ebf\u7a0b\u5462\uff0c16\u53f7\u7ebf\u7a0b\u5565\u4e5f\u4e0d\u5e72\uff0c\u56e0\u4e3as=16\uff0c16-31\u53f7\u7ebf\u7a0b\u5565\u4e5f\u4e0d\u5e72\uff0c\u8df3\u8fc7\u53bb\u4e86\u3002"}),"\n",(0,t.jsx)(d.h1,{id:"\u89e3\u51b3idle\u7ebf\u7a0b",children:"\u89e3\u51b3idle\u7ebf\u7a0b"}),"\n",(0,t.jsx)(d.p,{children:"reduce2\u6700\u5927\u7684\u95ee\u9898\u5c31\u662f\u7ebf\u7a0b\u7684\u6d6a\u8d39\u3002\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u542f\u52a8\u4e86256\u4e2a\u7ebf\u7a0b\uff0c\u4f46\u662f\u5728\u7b2c1\u8f6e\u8fed\u4ee3\u65f6\u53ea\u6709128\u4e2a\u7ebf\u7a0b\u5728\u5e72\u6d3b\uff0c\u7b2c2\u8f6e\u8fed\u4ee3\u53ea\u670964\u4e2a\u7ebf\u7a0b\u5728\u5e72\u6d3b\uff0c\u6bcf\u6b21\u5e72\u6d3b\u7684\u7ebf\u7a0b\u90fd\u4f1a\u51cf\u5c11\u4e00\u534a\u3002\u7b2c\u4e00\u8f6e\u8fed\u4ee3\u793a\u610f\u56fe\u5982\u4e0b\uff0c\u53ea\u6709\u524d128\u4e2a\u7ebf\u7a0b\u5728load\u6570\u636e\u3002\u540e128\u4e2a\u7ebf\u7a0b\u5565\u4e5f\u4e0d\u5e72\uff0c\u5149\u770b\u7740\u3002"}),"\n",(0,t.jsx)(d.p,{children:"Block\u6570\u91cf\u51cf\u5c11\uff0cNum_per_block\u589e\u52a0\u4e00\u500d\u3002\u4e5f\u5c31\u662f\u8bf4\u539f\u6765\u4e00\u4e2ablock\u53ea\u9700\u8981\u7ba1256\u4e2a\u6570\u5c31\u884c\uff0c\u73b0\u5728\u5f97\u7ba1512\u4e2a\u6570\u4e86\u3002"}),"\n",(0,t.jsx)(d.pre,{children:(0,t.jsx)(d.code,{className:"language-cuda",children:"__global__ void reduce3(float *d_in,float *d_out){\n    __shared__ float sdata[THREAD_PER_BLOCK];\n\n    //each thread loads one element from global memory to shared mem\n    unsigned int i=blockIdx.x*(blockDim.x*2)+threadIdx.x;\n    unsigned int tid=threadIdx.x;\n    sdata[tid]=d_in[i] + d_in[i+blockDim.x];\n    __syncthreads();\n\n    // do reduction in shared mem\n    for(unsigned int s=blockDim.x/2; s>0; s>>=1){\n        if(tid < s){\n            sdata[tid]+=sdata[tid+s];\n        }\n        __syncthreads();\n    }\n    \n    // write result for this block to global mem\n    if(tid==0)d_out[blockIdx.x]=sdata[tid];\n}\n"})}),"\n",(0,t.jsx)(d.h1,{id:"\u5c55\u5f00\u6700\u540e\u4e00\u7ef4\u51cf\u5c11\u540c\u6b65",children:"\u5c55\u5f00\u6700\u540e\u4e00\u7ef4\u51cf\u5c11\u540c\u6b65"}),"\n",(0,t.jsx)(d.pre,{children:(0,t.jsx)(d.code,{className:"language-cuda",children:"__device__ void warpReduce(volatile float* cache,int tid){\n    cache[tid]+=cache[tid+32];\n    cache[tid]+=cache[tid+16];\n    cache[tid]+=cache[tid+8];\n    cache[tid]+=cache[tid+4];\n    cache[tid]+=cache[tid+2];\n    cache[tid]+=cache[tid+1];\n}\n\n__global__ void reduce4(float *d_in,float *d_out){\n    __shared__ float sdata[THREAD_PER_BLOCK];\n\n    //each thread loads one element from global memory to shared mem\n    unsigned int i=blockIdx.x*(blockDim.x*2)+threadIdx.x;\n    unsigned int tid=threadIdx.x;\n    sdata[tid]=d_in[i] + d_in[i+blockDim.x];\n    __syncthreads();\n\n    // do reduction in shared mem\n    for(unsigned int s=blockDim.x/2; s>32; s>>=1){\n        if(tid < s){\n            sdata[tid]+=sdata[tid+s];\n        }\n        __syncthreads();\n    }\n    \n    // write result for this block to global mem\n    if(tid<32)warpReduce(sdata,tid);\n    if(tid==0)d_out[blockIdx.x]=sdata[tid];\n}\n"})})]})}function m(e={}){const{wrapper:d}={...(0,a.a)(),...e.components};return d?(0,t.jsx)(d,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},1519:(e,d,n)=>{n.d(d,{Z:()=>t});const t=n.p+"assets/images/image-7-0a95cbe2f211d041c472697ee629bc3b.png"},1151:(e,d,n)=>{n.d(d,{Z:()=>r,a:()=>o});var t=n(7294);const a={},i=t.createContext(a);function o(e){const d=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(d):{...d,...e}}),[d,e])}function r(e){let d;return d=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),t.createElement(i.Provider,{value:d},e.children)}}}]);