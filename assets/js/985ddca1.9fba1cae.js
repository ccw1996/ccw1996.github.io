"use strict";(self.webpackChunkblog_sample=self.webpackChunkblog_sample||[]).push([[418],{478:(n,t,e)=>{e.d(t,{A:()=>o});const o=e.p+"assets/images/image-2-4e1b6f2eea3218fea142c0ef605f426c.png"},3930:(n,t,e)=>{e.r(t),e.d(t,{assets:()=>c,contentTitle:()=>l,default:()=>p,frontMatter:()=>r,metadata:()=>o,toc:()=>a});const o=JSON.parse('{"id":"ml/optimization/custom_onnx_op","title":"onnx \u81ea\u5b9a\u4e49op\u5e76\u5bfc\u51fa","description":"https://blog.csdn.net/u011622208/article/details/122255317","source":"@site/docs/ml/optimization/custom_onnx_op.md","sourceDirName":"ml/optimization","slug":"/ml/optimization/custom_onnx_op","permalink":"/docs/ml/optimization/custom_onnx_op","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/edit/main/website/docs/ml/optimization/custom_onnx_op.md","tags":[{"inline":true,"label":"work","permalink":"/docs/tags/work"},{"inline":true,"label":"interview","permalink":"/docs/tags/interview"}],"version":"current","lastUpdatedAt":1740785860000,"frontMatter":{"title":"onnx \u81ea\u5b9a\u4e49op\u5e76\u5bfc\u51fa","tags":["work","interview"]},"sidebar":"tutorialSidebar","previous":{"title":"AudioLDM 2\uff0c\u52a0\u901f","permalink":"/docs/ml/optimization/SD\u6a21\u578b\u4f18\u5316"},"next":{"title":"\u518d\u6b21\u7406\u89e3 im2col","permalink":"/docs/ml/optimization/im2col"}}');var i=e(4848),s=e(8453);const r={title:"onnx \u81ea\u5b9a\u4e49op\u5e76\u5bfc\u51fa",tags:["work","interview"]},l=void 0,c={},a=[];function u(n){const t={a:"a",blockquote:"blockquote",code:"code",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(t.blockquote,{children:["\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.a,{href:"https://blog.csdn.net/u011622208/article/details/122255317",children:"https://blog.csdn.net/u011622208/article/details/122255317"})}),"\n"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-python",children:"import torch\nimport torch.nn as nn\nfrom torch.autograd import Function\nimport onnx\nimport torch.onnx\n\nclass Requant_(Function):\n    @staticmethod\n    def forward(ctx, input, requant_scale, shift):               # ctx \u5fc5\u987b\u8981\n        input = input.double() * requant_scale / 2**shift        # \u4e3a\u4e86\u7b49\u4ef7\u4e8ec\u4e2d\u7684\u79fb\u4f4d\u64cd\u4f5c\u3002\u4f1a\u5b58\u5728int32\u6ea2\u51fa\n        input = torch.floor(input).float()\n\n        return torch.floor(input)\n    \n    @staticmethod\n    def symbolic(g, *inputs):\n        return g.op(\"Requant\", inputs[0], scale_f=23.0, shift_i=8)\n\nrequant_ = Requant_.apply\n\nclass TinyNet(nn.Module):\n    def __init__(self):\n        super(TinyNet, self).__init__()\n        self.conv1 = nn.Conv2d(3, 1, kernel_size=3, padding=1)\n        self.relu1 = nn.ReLU()\n        \n    def forward(self, x):\n        x = self.conv1(x)\n        x = self.relu1(x)\n        x = x.view(-1)\n        x = requant_(x, 5, 5)\n        return x\n\nnet = TinyNet().cuda()\nipt = torch.ones(2,3,12,12).cuda()\ntorch.onnx.export(net, (ipt,), 'tinynet.onnx', opset_version=11, enable_onnx_checker=False)\nprint(onnx.load('tinynet.onnx'))\n"})}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"\u7ee7\u627f\u81eatorch.autograd"}),"\n",(0,i.jsx)(t.li,{children:"scale_f=23.0, shift_i=8\uff0c_f\u8868\u793a\u6d6e\u70b9\u6570\uff0c_i\u8868\u793a\u6574\u5f62int32\u7c7b\u578b"}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"Alt text",src:e(478).A+"",width:"843",height:"544"})})]})}function p(n={}){const{wrapper:t}={...(0,s.R)(),...n.components};return t?(0,i.jsx)(t,{...n,children:(0,i.jsx)(u,{...n})}):u(n)}},8453:(n,t,e)=>{e.d(t,{R:()=>r,x:()=>l});var o=e(6540);const i={},s=o.createContext(i);function r(n){const t=o.useContext(s);return o.useMemo((function(){return"function"==typeof n?n(t):{...t,...n}}),[t,n])}function l(n){let t;return t=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:r(n.components),o.createElement(s.Provider,{value:t},n.children)}}}]);